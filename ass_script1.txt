CLEAR COLUMNS
CLEAR BREAKS
CLEAR COMPUTES
TTITLE OFF
REPFOOTER OFF

ACCEPT year_no DATE FORMAT 'YYYY'-
PROMPT 'Enter the year : '

ACCEPT quarter1 CHAR -
PROMPT 'Enter First Quarter : '

ACCEPT quarter2 CHAR -
PROMPT 'Enter Second Quarter : '

ACCEPT TOP_N NUMBER FORMAT '99'-
PROMPT 'Enter Top N record : '

SET LINESIZE 150
SET PAGESIZE 50

COLUMN CAL_QUARTER Heading 'Quarter' FORMAT A8
COLUMN productname Heading 'Product Name' FORMAT A55
COLUMN priceeach Heading 'Unit Price' FORMAT $999.99
COLUMN QUANTIY Heading 'Total Sold'
COLUMN TOTAL Heading 'Total Sales' FORMAT $999999.99
COLUMN SALE_CONTRIBUTED Heading 'Contribution Sales(%)' FORMAT 990.90

CREATE OR REPLACE VIEW PRODUCT_SALES AS
SELECT *
FROM (
	SELECT D.CAL_QUARTER, P.productname, S.priceeach,
	SUM(S.quantityordered) AS QUANTITY, (S.priceeach * SUM(S.quantityordered)) AS TOTAL
FROM SALES_FACT S, DIM_DATE D, dim_products P
WHERE S.DATE_KEY = D.DATE_KEY AND
      S.product_key = P.product_key AND
      D.CAL_YEAR = '&year_no ' AND
      D.CAL_QUARTER BETWEEN '&quarter1' AND '&quarter2'
GROUP BY D.CAL_QUARTER, P.productname, S.priceeach
ORDER BY D.CAL_QUARTER, TOTAL DESC );

CREATE OR REPLACE VIEW TOTAL_QUARTER_SALE AS
SELECT CAL_QUARTER, SUM(TOTAL) AS QUARTER_SALES
FROM PRODUCT_SALES
WHERE CAL_QUARTER BETWEEN '&quarter1' AND '&quarter2'
GROUP BY CAL_QUARTER;

CREATE OR REPLACE VIEW TOP_SALES_Q1 AS
SELECT *
FROM (
	SELECT A.productname, A.CAL_QUARTER, A.priceeach,
	A.QUANTITY, A.TOTAL, ((A.TOTAL/B.QUARTER_SALES) * 100 ) AS SALE_CONTRIBUTED
FROM PRODUCT_SALES A, TOTAL_QUARTER_SALE B
WHERE A.CAL_QUARTER = '&quarter1' AND
      A.CAL_QUARTER = B.CAL_QUARTER
ORDER BY TOTAL DESC)
WHERE ROWNUM <= '&TOP_N' ;

CREATE OR REPLACE VIEW TOP_SALES_Q2 AS
SELECT *
FROM (
	SELECT A.productname, A.CAL_QUARTER, A.priceeach,
	A.QUANTITY, A.TOTAL, ((A.TOTAL/B.QUARTER_SALES) * 100 ) AS SALE_CONTRIBUTED
FROM PRODUCT_SALES A, TOTAL_QUARTER_SALE B
WHERE A.CAL_QUARTER = '&quarter2' AND
      A.CAL_QUARTER = B.CAL_QUARTER
ORDER BY TOTAL DESC)
WHERE ROWNUM <= '&TOP_N' ;

CLEAR SCREEN

TTITLE CENTER 'Comparison TOP '&TOP_N' Product Sales between Quarter '&quarter1' and '&quarter2' in '&year_no' 'SKIP 1 CENTER ------------------------------------------------------------------------------ SKIP 1 -
LEFT'Page:' FORMAT 99 SQL.PNO SKIP 2
REPFOOTER SKIP 1 CENTER '---END OF REPORT---' SKIP 1
BREAK ON RESTNAME ON CAL_QUARTER SKIP 1

SELECT *
FROM TOP_SALES_Q1
UNION ALL
SELECT *
FROM TOP_SALES_Q2;